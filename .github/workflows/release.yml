name: ğŸš€ Release & Deploy

on:
  push:
    branches: [main]
    # SÃ³ roda se os testes passaram
  workflow_run:
    workflows: ['ğŸ Continuous Integration']
    types: [completed]
    branches: [main]

jobs:
  # ğŸ“‹ CREATE RELEASE
  release:
    name: ğŸ“‹ Create Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Generate changelog since last tag
          CHANGELOG=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT  
          echo "EOF" >> $GITHUB_OUTPUT

          # Create new version
          VERSION=$(date +'v%Y.%m.%d.%H%M')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.changelog.outputs.version }}
          release_name: Release ${{ steps.changelog.outputs.version }}
          body: |
            ## ğŸ Placar de VÃ´lei - Release ${{ steps.changelog.outputs.version }}

            ### âœ¨ Changes in this release:
            ${{ steps.changelog.outputs.changelog }}

            ### ğŸ“Š Test Results:
            - âœ… All unit tests passed
            - âœ… All BDD scenarios passed  
            - âœ… Code quality checks passed
            - âœ… Build successful

            ### ğŸš€ Deployment:
            Automatically deployed to production via Vercel.

            ---
            Generated automatically by GitHub Actions ğŸ¤–
          draft: false
          prerelease: false

  # ğŸ“Š DEPLOYMENT STATS
  deployment-notification:
    name: ğŸ“Š Deployment Notification
    runs-on: ubuntu-latest
    needs: [release]
    if: always()

    steps:
      - name: ğŸ“Š Post deployment stats
        run: |
          echo "ğŸš€ DEPLOYMENT COMPLETED!"
          echo ""
          echo "ğŸ“¦ Project: Volley Driven Development"
          echo "ğŸŒ Environment: Production (Vercel)"
          echo "â° Deployed at: $(date)"
          echo "ğŸ”— CI/CD: GitHub Actions"
          echo "ğŸ“‹ Release: Created automatically"
          echo ""
          echo "ğŸ Ready to track volleyball scores!"
